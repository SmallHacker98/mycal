<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity PWA Calendar Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --modal-bg: rgba(0, 0, 0, 0.4);
            --sunday-bg: #fff1f2;
            --saturday-bg: #eff6ff;
            --holiday-text: #ef4444;
            --today-accent: rgba(37, 99, 235, 0.1);
        }

        /* ナイトモード設定 */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --surface: #1e293b;
                --text: #f1f5f9;
                --border: #334155;
                --modal-bg: rgba(0, 0, 0, 0.7);
                --sunday-bg: rgba(244, 63, 94, 0.15);
                --saturday-bg: rgba(59, 130, 246, 0.15);
                --holiday-text: #fb7185;
                --today-accent: rgba(59, 130, 246, 0.2);
            }
            .fc {
                --fc-page-bg-color: #1e293b;
                --fc-border-color: #334155;
            }
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: 0.3s; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        #calendar-container { padding: 1rem; max-width: 1400px; margin: 0 auto; }
        #calendar { background: var(--surface); padding: 1rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); height: calc(100vh - 120px); }

        /* 曜日・祝日・今日の強調スタイル */
        .fc-day-sun, .fc-day-holiday { background-color: var(--sunday-bg) !important; }
        .fc-day-sat { background-color: var(--saturday-bg) !important; }
        .holiday-label { color: var(--holiday-text); font-size: 0.7rem; font-weight: 800; display: block; margin-top: 4px; }
        
        /* 今日の強調 */
        .fc .fc-day-today { background-color: var(--today-accent) !important; }
        .fc .fc-day-today .fc-daygrid-day-number {
            background-color: var(--primary); color: white !important; border-radius: 50%;
            min-width: 1.8em; height: 1.8em; display: inline-flex; align-items: center; justify-content: center; margin: 2px;
        }
        .fc-daygrid-day-number { font-weight: 600; padding: 4px 8px !important; }
        .fc-day-sun .fc-daygrid-day-number, .fc-day-holiday .fc-daygrid-day-number { color: var(--holiday-text); }

        /* モーダル */
        #eventModal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: var(--modal-bg); backdrop-filter: blur(8px); }
        .modal-content { background: var(--surface); margin: 5% auto; padding: 2rem; width: 90%; max-width: 420px; border-radius: 24px; animation: slideUp 0.3s ease-out; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 700; opacity: 0.9; }
        input { width: 100%; padding: 0.85rem; border: 1px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); box-sizing: border-box; font-size: 1rem; }
        .tag-group { display: flex; gap: 10px; }
        .tag-btn { flex: 1; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; font-size: 0.8rem; font-weight: 800; border: 3px solid transparent; transition: 0.2s; }
        .tag-btn.active { border-color: var(--text); transform: scale(0.96); }
        .modal-footer { display: flex; flex-direction: column; gap: 10px; margin-top: 2rem; }
        .btn { padding: 1rem; border-radius: 14px; border: none; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 800; font-size: 1.4rem; color: var(--primary);">Pro PWA Cal</div>
    <div style="font-size: 0.75rem; font-weight: 600; opacity: 0.6; background: var(--border); padding: 4px 12px; border-radius: 20px;">Today & Holiday Optimized</div>
</header>

<div id="calendar-container">
    <div id="calendar"></div>
</div>

<div id="eventModal">
    <div class="modal-content">
        <h2 style="margin: 0 0 1.5rem 0; font-size: 1.3rem;">予定を登録</h2>
        <div class="form-group"><label>タイトル</label><input type="text" id="eventTitle" placeholder="例: 現場導入フェーズ1"></div>
        <div style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;"><label>開始</label><input type="time" id="startTime" value="09:00"></div>
            <div class="form-group" style="flex: 1;"><label>終了</label><input type="time" id="endTime" value="10:00"></div>
        </div>
        <div class="form-group">
            <label>カテゴリー</label>
            <div class="tag-group">
                <div id="tw" class="tag-btn" style="background:#3b82f6; color:white;" onclick="selTag('#3b82f6', 'tw')">仕事</div>
                <div id="tp" class="tag-btn" style="background:#10b981; color:white;" onclick="selTag('#10b981', 'tp')">私用</div>
                <div id="to" class="tag-btn" style="background:#64748b; color:white;" onclick="selTag('#64748b', 'to')">その他</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="doSave(false)">保存する</button>
            <button class="btn btn-success" onclick="doSave(true)">保存してiCal出力</button>
            <button class="btn" style="background:none; color:var(--text)" onclick="closeModal()">キャンセル</button>
        </div>
    </div>
</div>

<script>
    let calendar, selectedInfo, currentTagColor = '#3b82f6';

    function getHolidayName(date) {
        const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate(), w = date.getDay();
        const fixed = {"01-01":"元日","02-11":"建国記念の日","02-23":"天皇誕生日","04-29":"昭和の日","05-03":"憲法記念日","05-04":"みどりの日","05-05":"こどもの日","11-03":"文化の日","11-23":"勤労感謝の日"};
        if(fixed[`${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`]) return fixed[`${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`];
        const nthW = Math.floor((d - 1) / 7) + 1;
        if(w === 1) {
            if(m === 1 && nthW === 2) return "成人の日";
            if(m === 7 && nthW === 3) return "海の日";
            if(m === 9 && nthW === 3) return "敬老の日";
            if(m === 10 && nthW === 2) return "スポーツの日";
        }
        if(y >= 2016 && m === 8 && d === 11) return "山の日";
        if(m === 3 && d === Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return "春分の日";
        if(m === 9 && d === Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return "秋分の日";
        return null;
    }

    function isTransferHoliday(date) {
        const prev = new Date(date); prev.setDate(date.getDate() - 1);
        return (date.getDay() === 1 && getHolidayName(prev));
    }

    document.addEventListener('DOMContentLoaded', function() {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'multiMonthYear,dayGridMonth,timeGridWeek,timeGridDay' },
            locale: 'ja', selectable: true, navLinks: true, nowIndicator: true,
            events: JSON.parse(localStorage.getItem('pwa_cal_final') || '[]'),
            dayCellContent: (arg) => {
                let name = getHolidayName(arg.date) || (isTransferHoliday(arg.date) ? "振替休日" : null);
                let html = `<div class="fc-daygrid-day-number">${arg.dayNumberText}</div>`;
                if(name) html += `<span class="holiday-label">${name}</span>`;
                return { html };
            },
            dayCellDidMount: (arg) => {
                if(getHolidayName(arg.date) || isTransferHoliday(arg.date)) arg.el.classList.add('fc-day-holiday');
            },
            select: (info) => { selectedInfo = info; document.getElementById('eventModal').style.display='block'; }
        });
        calendar.render();
        selTag('#3b82f6', 'tw');
    });

    function selTag(c, id) { currentTagColor = c; document.querySelectorAll('.tag-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function closeModal() { document.getElementById('eventModal').style.display='none'; }
    function doSave(isExport) {
        const title = document.getElementById('eventTitle').value;
        if(!title) return;
        const ev = { title, start: `${selectedInfo.startStr.split('T')[0]}T${document.getElementById('startTime').value}:00`, end: `${selectedInfo.startStr.split('T')[0]}T${document.getElementById('endTime').value}:00`, backgroundColor: currentTagColor, borderColor: 'transparent' };
        calendar.addEvent(ev);
        localStorage.setItem('pwa_cal_final', JSON.stringify(calendar.getEvents().map(e=>({title:e.title, start:e.startStr, end:e.endStr, backgroundColor:e.backgroundColor}))));
        if(isExport) {
            const f = d => d.replace(/[-:]/g,'').split('.')[0]+"Z";
            const ics = `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nBEGIN:VEVENT\r\nSUMMARY:${title}\r\nDTSTART:${f(ev.start)}\r\nDTEND:${f(ev.end)}\r\nEND:VEVENT\r\nEND:VCALENDAR`;
            const a = document.createElement("a"); a.href=URL.createObjectURL(new Blob([ics],{type:"text/calendar"})); a.download=`${title}.ics`; a.click();
        }
        closeModal();
    }
</script>
</body>
</html>
